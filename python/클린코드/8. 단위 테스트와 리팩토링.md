# 단위 테스트와 리팩토링



## 디자인 원칙과 단위 테스트

단위 테스트는 다른 코드의 일부분이 유효한지를 검사하는 코드이다.

단위 테스트는 소프트웨어의 핵심이 되는 필수적인 기능으로서 일반 비즈니스 로직과 동일한 수준으로 다루어져야 한다.

단위 테스트는 다음과 같은 특징을 가진다.

- **격리: ** 다른 외부 에이전트와 완전히 독립적(HTTP 요청이나, 데이터베이스 연결이 없다.)이고 비즈니스 로직에만 집중해야한다. 또한 테스트 자체가 독립적이다. 테스트는 이전 상태에 관계없이 임의의 순서로 실행될 수 있어야 한다.
- **성능: ** 신속하게 실행되어야 한다. 반복적으로 여러 번 실행될 수 있도록 설계해야 한다.
- **자체 검증**: 단위 테스트의 실행만으로 결과를 검증할 수 있어야 한다. 단위 테스트를 처리하기 위한 추가 단계가 없어야 한다.



### 자동화된 테스트의 다른 형태

함수 또는 메서드와 같은 매우 작은 단위를 확인하기 위한 것이다. 최대한 자세하게 코드를 검사하는 것이 목적이다. 클래스를 테스트하려면 단위 테스트가 아니라 단위 테스트의 집합인 **테스트 스위트**를 작성한다.

**통합 테스트**는 한번에 여러 컴포넌트를 생성한다. 종합적으로 예상대로 잘 동작하는지 검증한다. 이 경우 부작용이나 격리를 고려하지 않은 채로, 즉 HTTP 요청이나 데이터베이스 연결의 작업 수행이 가능하다.

**인수 테스트**는 유스케이스를 활용하여 사용자의 관점에서 시스템의 유효성을 검사하는 자동화된 테스트이다.

이 두가지 테스트를 하게되면 테스트의 **속도** 문제가 발생하게 된다. 이를 해결하기 위해 단위 테스트는 많이 실행하고 항상 실행하며, 통합 테스트는 덜 자주 실행하도록 한다. 예를 들어 새로운 머지 리퀘스트가 있을 경우에만 통합 테스트를 할 수 있다.



### 단위 테스트와 애자일 소프트웨어 개발

최근 소프트웨어 개발은 가능한 한 신속하고 지속적으로 가치를 제공하려 한다.

단위 테스트가 프로그램이 명세에 따라 정확하게 동작하는 공식적 증거가 될 수 없다. 좋은 테스트를 작성했다면 프로젝트를 중단하지 않고 신속하게 가치를 제공할 가능성이 높아진다.



### 테스트의 경계

테스트의 범위는 우리가 작성한 코드의 범위로 한정해야 한다.

외부 의존성의 경우 올바른 파라미터를 사용해 호출하면 정상적으로 실행된다는 것만 확인해도 충분하다.



## Mock

외부 서비스에는 필연적 부작용이 존재한다. 부작용을 최소화하기 위해 외부 요소를 분리하고 인터페이스를 사용해 추상화하겠지만 이러한 부분 역시 테스트에 포함되어야하며 효과적으로 처리할 수 있어야 한다.

Mock 객체는 원하지 않는 부작용으로부터 테스트 코드를 보호하는 가장 좋은 방법 중 하나이다. 코드에서 HTTP 요청을 수행하거나 알림 이메일을 보내야 할 수도 있지만, 단위 테스트에서 확인할 내용은 아니다. 게다가 단위 테스트는 빠르게 실행되어야 하기 때문에 이러한 대기 시간을 감당할 수 없다. 따라서 단위 테스트에서는 이러한 외부 서비스를 호출하지 않는다.



### Mock에 대한 주의 사항

간단한 테스트  케이스를 작성하기 위해 다양한 Mock을 해야 한다면 코드에서 나쁜 냄새가 난다는 신호이다.

Mock을 사용하는 것 자체는 문제가 되지 않지만 Mock 을 남용한다면 원본 코드를 개선할 여지가 있다는 신호이다.



### Mock 객체 사용하기

mock은 응답해야 하는 값이나 행동을 특정할 수 있다. 이를 사용하여 애플리케이션의 동작을 검증한다.

이는 외부 HTTP 요청에 대해 주어진 값을 사용하여 처리할 수 있다.



## 리팩토링

소프트웨어 유지 관리에서 중요한 활동이지만 단위 테스트가 없다면 정확성을 보장하기는 어려울 것이다.

리팩토링은 구조를 개선할 목적, 일반적인 코드로 수정하여 가독성을 높이려는 목적 등을 가지고있다. 제일 중요한 점은 작업 이전과 이후가 완전히 동일한 기능을  유지해야 한다는 것이다.



## 단위 테스트의 완벽성

작성한 테스트의 완벽성, 정확성은 어떻게 알 수 있을까



### 완벽성: 속성 기반 테스트

테스트를 실패하게 만드는 데이터를 찾는 것이다.

**hypothesis** 라이브러리를 사용하여 코드를 실패하게 만드는 데이터를 찾는데 도움을 준다.



### 정확성: 변형 테스트

변형 테스트 도구를 사용하면 원래 코드를 변경한 새로운 버전으로 코드가 수정된다. (예: 연산자를 교체하거나 조건을 변경). 좋은 스위트는 이러한 돌연변이를 죽여야 하는데 이런 경우 테스트에 의지할 수 있음을 의미한다. 일부 돌연변이가 실험에서 생존하면 대개 나쁜 징조이다.

이 도구를 복잡한 환경에서 사용한다면 각 시나리오 분석에서 시간과 비용이 발생한다. 그러나 이 작업을 수동으로 한다면 더 많은 노력이 필요할 것이다.



## TDD

TDD의 요점은 기능의 결함으로 실패하게 될 테스트를 상용화전 미리 작성해야 한다는 것이다.

**red-green-refactor**의 과정으로 소프트웨어를 개발한다.